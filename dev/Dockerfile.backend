FROM python:3.10-slim

# Install system dependencies including ffmpeg and wget
RUN apt-get update && apt-get install -y \
    ffmpeg \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install Poetry
RUN pip install poetry

# Configure Poetry to create virtualenv in a fixed location
ENV POETRY_NO_INTERACTION=1 \
    POETRY_VIRTUALENVS_IN_PROJECT=0 \
    POETRY_VIRTUALENVS_PATH=/opt/venv \
    POETRY_CACHE_DIR=/root/.cache/pypoetry

WORKDIR /app

# Copy Poetry files
COPY pyproject.toml poetry.lock ./

# Install ALL dependencies including the project
# This creates the virtualenv at /opt/venv which stays in the image
RUN poetry install

# Download YOLO models if they don't exist
RUN mkdir -p /app/models && \
    if [ ! -f /app/models/yolov8n.pt ]; then \
        wget -q https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8n.pt -O /app/models/yolov8n.pt; \
    fi && \
    if [ ! -f /app/models/yolov8n-face.pt ]; then \
        wget -q https://github.com/derronqi/yolov8-face/releases/download/v0.0.0/yolov8n-face.pt -O /app/models/yolov8n-face.pt; \
    fi && \
    if [ ! -f /app/models/resnet18_places365.pth.tar ]; then \
        wget -q http://places2.csail.mit.edu/models_places365/resnet18_places365.pth.tar -O /app/models/resnet18_places365.pth.tar; \
    fi && \
    if [ ! -f /app/categories_places365.txt ]; then \
        wget -q https://raw.githubusercontent.com/CSAILVision/places365/master/categories_places365.txt -O /app/categories_places365.txt; \
    fi

# The virtualenv is now baked into the image
# Source code will be mounted as a volume at runtime
